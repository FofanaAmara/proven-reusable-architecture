name: Status Transition Check

# Workflow for validating PRA status transitions
# Runs on: pull_request (opened, synchronize)
#
# Validates transitions:
# - Candidate ‚Üí Approved (Domain): requires 1+ proven-in-use
# - Candidate ‚Üí Approved (Bank-Wide): requires 3+ proven-in-use from different domains
# - Any ‚Üí Deprecated: requires alternative mention

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'site/content/**/registre/**/*.md'
      - 'site/content/**/registre/**/*.mdx'

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  check-status-transition:
    name: Validate Status Transitions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g gray-matter

      - name: Get changed PRA files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            site/content/**/registre/**/*.md
            site/content/**/registre/**/*.mdx
          files_ignore: |
            site/content/**/registre/index.md
            site/content/**/registre/guides/**

      - name: Check status transitions
        if: steps.changed-files.outputs.any_changed == 'true'
        id: check
        run: |
          echo "Checking status transitions..."

          TRANSITION_ERRORS=0
          WARNINGS=""

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ ! -f "$file" ]; then
              continue
            fi

            echo ""
            echo "Checking: $file"

            # Get current status
            CURRENT_STATUS=$(node -e "
              const fs = require('fs');
              const matter = require('gray-matter');
              const content = fs.readFileSync('$file', 'utf-8');
              const { data } = matter(content);
              console.log(data.pra?.status || 'unknown');
            ")

            # Get base status (if file existed before)
            BASE_STATUS="unknown"
            if git show origin/${{ github.base_ref }}:$file > /dev/null 2>&1; then
              git show origin/${{ github.base_ref }}:$file > base_temp.md
              BASE_STATUS=$(node -e "
                const fs = require('fs');
                const matter = require('gray-matter');
                const content = fs.readFileSync('base_temp.md', 'utf-8');
                const { data } = matter(content);
                console.log(data.pra?.status || 'unknown');
              ")
              rm base_temp.md
            fi

            echo "Status transition: $BASE_STATUS ‚Üí $CURRENT_STATUS"

            # Check if status changed
            if [ "$BASE_STATUS" != "$CURRENT_STATUS" ] && [ "$BASE_STATUS" != "unknown" ]; then
              echo "üìä Status transition detected"

              # Get proven-in-use count
              PROVEN_COUNT=$(node -e "
                const fs = require('fs');
                const matter = require('gray-matter');
                const content = fs.readFileSync('$file', 'utf-8');
                const { data } = matter(content);
                const count = data.pra?.proven_in_use?.length || 0;
                console.log(count);
              ")

              # Determine scope
              SCOPE="domain"
              if echo "$file" | grep -q "transversal/"; then
                SCOPE="bank-wide"
              fi

              # Validate transition: Candidate ‚Üí Approved
              if [ "$BASE_STATUS" = "candidate" ] && [ "$CURRENT_STATUS" = "approved" ]; then
                echo "Validating Candidate ‚Üí Approved transition..."

                if [ "$SCOPE" = "bank-wide" ]; then
                  # Bank-Wide: requires 3+ proven-in-use
                  if [ "$PROVEN_COUNT" -lt 3 ]; then
                    echo "‚ùå ERROR: Bank-Wide Approved PRA requires 3+ proven-in-use (found: $PROVEN_COUNT)"
                    WARNINGS="${WARNINGS}\n- ‚ùå \`$file\`: Bank-Wide Approved requires 3+ proven-in-use (found: $PROVEN_COUNT)"
                    TRANSITION_ERRORS=$((TRANSITION_ERRORS + 1))
                  else
                    echo "‚úÖ Sufficient proven-in-use for Bank-Wide Approved ($PROVEN_COUNT)"
                  fi
                else
                  # Domain: requires 1+ proven-in-use
                  if [ "$PROVEN_COUNT" -lt 1 ]; then
                    echo "‚ùå ERROR: Domain Approved PRA requires 1+ proven-in-use (found: $PROVEN_COUNT)"
                    WARNINGS="${WARNINGS}\n- ‚ùå \`$file\`: Domain Approved requires 1+ proven-in-use (found: $PROVEN_COUNT)"
                    TRANSITION_ERRORS=$((TRANSITION_ERRORS + 1))
                  else
                    echo "‚úÖ Sufficient proven-in-use for Domain Approved ($PROVEN_COUNT)"
                  fi
                fi
              fi

              # Validate transition: ‚Üí Deprecated
              if [ "$CURRENT_STATUS" = "deprecated" ]; then
                echo "‚ö†Ô∏è  Deprecation detected - will require alternative mention"
                WARNINGS="${WARNINGS}\n- ‚ö†Ô∏è  \`$file\`: Deprecated - ensure alternative PRA is mentioned in content"
              fi
            fi
          done

          # Save warnings for comment
          echo "warnings<<EOF" >> $GITHUB_OUTPUT
          echo -e "$WARNINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "transition_errors=$TRANSITION_ERRORS" >> $GITHUB_OUTPUT

          # Summary
          echo ""
          echo "========================================="
          echo "Status Transition Check Summary"
          echo "========================================="
          echo "Files checked: ${{ steps.changed-files.outputs.all_changed_files_count }}"
          echo "Transition errors: $TRANSITION_ERRORS"

          if [ $TRANSITION_ERRORS -gt 0 ]; then
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Status transition validation failed ($TRANSITION_ERRORS error(s))" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All status transitions are valid" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Update commit status
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.check.outputs.state }}' || 'success';
            const description = '${{ steps.check.outputs.description }}' || 'No status transitions detected';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              description: description,
              context: 'PRA Status Transition Check'
            });

      - name: Add warnings comment
        if: steps.check.outputs.warnings != '' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const warnings = `${{ steps.check.outputs.warnings }}`;
            const errors = parseInt('${{ steps.check.outputs.transition_errors }}') || 0;

            if (!warnings.trim()) {
              console.log('No warnings to display');
              return;
            }

            let message = '## üìä Status Transition Check\n\n';

            if (errors > 0) {
              message += '**‚ùå Status transition validation failed**\n\n';
              message += 'The following issues were found:\n\n';
              message += warnings;
              message += '\n\n---\n\n';
              message += '### How to fix:\n\n';
              message += '**For Approved status:**\n';
              message += '- Domain PRAs: Add at least 1 proven-in-use entry\n';
              message += '- Bank-Wide PRAs: Add at least 3 proven-in-use entries from different domains/teams\n\n';
              message += '**For Deprecated status:**\n';
              message += '- Mention the recommended alternative PRA in the content\n';
              message += '- Provide a migration path for users\n\n';
              message += 'See [Lifecycle Guide](/site/content/en/guides/04-lifecycle.md) for details.';
            } else {
              message += '**‚úÖ All status transitions are valid**\n\n';
              message += warnings;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: No PRA files changed
        if: steps.changed-files.outputs.any_changed == 'false'
        run: |
          echo "‚ÑπÔ∏è  No PRA files were changed in this PR"
          echo "Status transition check skipped"
