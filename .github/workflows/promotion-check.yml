name: Promotion Check

# Workflow for validating PRA promotions (Domain ‚Üí Bank-Wide)
# Runs on: pull_request (opened, synchronize)
#
# Detects and validates:
# - File moved from secteurs/* to transversal/*
# - 3+ proven-in-use from different domains/teams
# - Proper documentation for multi-domain applicability

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-promotion:
    name: Detect and Validate Promotions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g gray-matter

      - name: Detect file movements (promotions)
        id: detect
        run: |
          echo "Detecting potential promotions..."

          # Get all changed files
          CHANGED_FILES=$(git diff --name-status origin/${{ github.base_ref }}...HEAD | grep -E "\.mdx?$" || true)

          PROMOTIONS=""
          PROMOTION_COUNT=0

          echo "$CHANGED_FILES" | while read -r line; do
            STATUS=$(echo "$line" | awk '{print $1}')
            FILE=$(echo "$line" | awk '{print $2}')

            # Check for renames (R) or moves
            if [ "$STATUS" = "R" ] || [ "$STATUS" = "R100" ]; then
              OLD_FILE=$(echo "$line" | awk '{print $2}')
              NEW_FILE=$(echo "$line" | awk '{print $3}')

              # Check if moved from secteurs/ to transversal/
              if echo "$OLD_FILE" | grep -q "secteurs/" && echo "$NEW_FILE" | grep -q "transversal/"; then
                echo "üöÄ Promotion detected: $OLD_FILE ‚Üí $NEW_FILE"
                PROMOTIONS="${PROMOTIONS}\n${NEW_FILE}"
                PROMOTION_COUNT=$((PROMOTION_COUNT + 1))
              fi
            fi
          done

          echo "promotions<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PROMOTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "promotion_count=$PROMOTION_COUNT" >> $GITHUB_OUTPUT

          echo "Found $PROMOTION_COUNT promotion(s)"

      - name: Validate promotions
        if: steps.detect.outputs.promotion_count > 0
        id: validate
        run: |
          echo "Validating promotions..."

          PROMOTIONS="${{ steps.detect.outputs.promotions }}"
          VALIDATION_ERRORS=0
          VALIDATION_WARNINGS=""

          echo "$PROMOTIONS" | while read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            echo ""
            echo "========================================="
            echo "Validating promotion: $file"
            echo "========================================="

            # Check file exists
            if [ ! -f "$file" ]; then
              echo "‚ö†Ô∏è  File not found, skipping"
              continue
            fi

            # Get proven-in-use count
            PROVEN_COUNT=$(node -e "
              const fs = require('fs');
              const matter = require('gray-matter');
              const content = fs.readFileSync('$file', 'utf-8');
              const { data } = matter(content);
              const count = data.pra?.proven_in_use?.length || 0;
              console.log(count);
            ")

            echo "Proven-in-use count: $PROVEN_COUNT"

            # Validate: requires 3+ proven-in-use
            if [ "$PROVEN_COUNT" -lt 3 ]; then
              echo "‚ùå ERROR: Promotion requires 3+ proven-in-use from different domains (found: $PROVEN_COUNT)"
              VALIDATION_WARNINGS="${VALIDATION_WARNINGS}\n- ‚ùå \`$file\`: Requires 3+ proven-in-use (found: $PROVEN_COUNT)"
              VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
            else
              echo "‚úÖ Sufficient proven-in-use ($PROVEN_COUNT)"

              # Check if from different domains (optional validation)
              DOMAINS=$(node -e "
                const fs = require('fs');
                const matter = require('gray-matter');
                const content = fs.readFileSync('$file', 'utf-8');
                const { data } = matter(content);
                const proven = data.pra?.proven_in_use || [];
                const teams = proven.map(p => p.team).filter(Boolean);
                const uniqueTeams = [...new Set(teams)];
                console.log(uniqueTeams.length);
              ")

              if [ "$DOMAINS" -lt 2 ]; then
                echo "‚ö†Ô∏è  WARNING: All proven-in-use from same team - consider multi-domain validation"
                VALIDATION_WARNINGS="${VALIDATION_WARNINGS}\n- ‚ö†Ô∏è  \`$file\`: All implementations from same team (recommend multi-domain)"
              else
                echo "‚úÖ Multi-domain implementations detected"
              fi
            fi
          done

          echo "warnings<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALIDATION_WARNINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "validation_errors=$VALIDATION_ERRORS" >> $GITHUB_OUTPUT

          echo ""
          echo "Validation complete: $VALIDATION_ERRORS error(s)"

          if [ $VALIDATION_ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: Apply promotion label
        if: steps.detect.outputs.promotion_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['type:promotion']
            });

            console.log('‚úÖ Applied label: type:promotion');

      - name: Add promotion guidance comment
        if: steps.detect.outputs.promotion_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const promotionCount = parseInt('${{ steps.detect.outputs.promotion_count }}');
            const validationErrors = parseInt('${{ steps.validate.outputs.validation_errors }}') || 0;
            const warnings = `${{ steps.validate.outputs.warnings }}`;

            let message = `## üöÄ PRA Promotion Detected\n\n`;
            message += `This PR promotes **${promotionCount}** PRA(s) from domain-specific to bank-wide.\n\n`;

            if (validationErrors > 0) {
              message += '### ‚ùå Validation Failed\n\n';
              message += warnings;
              message += '\n\n**Action required:** Please address the errors above before this PR can be approved.\n\n';
            } else {
              message += '### ‚úÖ Validation Passed\n\n';
              if (warnings.trim()) {
                message += warnings + '\n\n';
              }
            }

            message += '---\n\n';
            message += '### üìã Promotion Checklist\n\n';
            message += 'Please ensure:\n\n';
            message += '- [ ] **3+ proven-in-use** documented from **different domains/teams**\n';
            message += '- [ ] **Multi-domain applicability** clearly demonstrated in content\n';
            message += '- [ ] **Documentation enriched** with learnings from multiple contexts\n';
            message += '- [ ] **Original domain committee** has approved this promotion\n';
            message += '- [ ] **Positive feedback** from teams (satisfaction > 7/10)\n\n';

            message += '### ‚è±Ô∏è Timeline\n\n';
            message += '**Expected review time:** 4-8 weeks\n\n';
            message += 'Promotions require thorough review by the Expert Architects Committee to ensure:\n';
            message += '- Cross-domain reusability\n';
            message += '- No domain-specific assumptions\n';
            message += '- Alignment with bank-wide standards\n\n';

            message += '### üë• Reviewers\n\n';
            message += 'This PR will be automatically assigned to: **@bnc/comite-architectes-experts**\n\n';

            message += '---\n\n';
            message += 'For more information, see:\n';
            message += '- [Promotion Process](/site/content/en/guides/07-promotion-process.md)\n';
            message += '- [Governance](/site/content/en/guides/08-governance.md)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: No promotions detected
        if: steps.detect.outputs.promotion_count == 0
        run: |
          echo "‚ÑπÔ∏è  No promotions detected in this PR"
          echo "Check skipped"

      - name: Fail if validation errors
        if: steps.detect.outputs.promotion_count > 0 && steps.validate.outputs.validation_errors > 0
        run: |
          echo "‚ùå Promotion validation failed"
          exit 1
